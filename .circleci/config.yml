version: 2.1
EB_APP=$(terraform output -raw eb_app_name)
EB_ENV=$(terraform output -raw eb_env_name)
IMAGE_URI=$(terraform output -raw image_uri)
echo "Creating new application version using image $IMAGE_URI for $EB_APP -> $EB_ENV"
aws elasticbeanstalk create-application-version --application-name $EB_APP --version-label "$IMAGE_TAG" --source-bundle S3Bucket=$EB_S3_BUCKET,S3Key=dummy || true
# elastic beanstalk update to use new image requires Dockerrun or platform; real world: you'll upload a Dockerrun.json to S3 or use eb cli
echo "NOTE: final EB update step may require additional EB-specific steps (upload Dockerrun to S3)"


push-and-deploy-azure:
docker:
- image: cimg/base:stable
parameters:
image_tag:
type: string
default: "latest"
steps:
- checkout
- attach_workspace:
at: .
- run:
name: Login to Azure (service principal)
command: |
if [ -z "$AZURE_CLIENT_ID" ] || [ -z "$AZURE_CLIENT_SECRET" ] || [ -z "$AZURE_TENANT_ID" ] || [ -z "$AZURE_SUBSCRIPTION_ID" ]; then
echo "Azure environment variables missing"; exit 1
fi
az login --service-principal -u "$AZURE_CLIENT_ID" -p "$AZURE_CLIENT_SECRET" --tenant "$AZURE_TENANT_ID"
az account set --subscription "$AZURE_SUBSCRIPTION_ID"
- run:
name: Push to ACR
command: |
chmod +x ./scripts/push_to_acr.sh
./scripts/push_to_acr.sh ${IMAGE_TAG}
- run:
name: Terraform apply for Azure
command: |
cd terraform/azure
terraform init -input=false
terraform apply -auto-approve -var="image_tag=${IMAGE_TAG}"
- run:
name: Update Web App to use new image
command: |
cd terraform/azure
WEBAPP=$(terraform output -raw webapp_name)
ACR_NAME=$(terraform output -raw acr_name)
IMAGE_NAME=$(terraform output -raw image_name)
FULL_IMAGE=${ACR_NAME}.azurecr.io/${IMAGE_NAME}:${IMAGE_TAG}
az webapp config container set --name $WEBAPP --resource-group $(terraform output -raw resource_group) --docker-custom-image-name $FULL_IMAGE


workflows:
build-deploy:
jobs:
- build-and-test
- push-and-deploy-aws:
requires:
- build-and-test
image_tag: << pipeline.parameters.IMAGE_TAG >>
filters:
branches:
only: main
- push-and-deploy-azure:
requires:
- build-and-test
image_tag: << pipeline.parameters.IMAGE_TAG >>
filters:
branches:
only: main