version: 2.1

orbs:
  python: circleci/python@1.6.0

parameters:
  image_tag:
    type: string
    default: "latest"

jobs:
  build-and-test:
    docker:
      - image: cimg/python:3.11
    steps:
      - checkout
      - python/install-packages:
          packages: 'pip'
      - run:
          name: Install test deps
          command: |
            python -m pip install --upgrade pip
            pip install -r app/requirements.txt
      - run:
          name: Run tests
          command: |
            pytest -q
      - setup_remote_docker
      - run:
          name: Build Docker image
          command: |
            IMAGE_TAG=${IMAGE_TAG:-${CIRCLE_BUILD_NUM:-latest}}
            IMAGE_NAME=${CIRCLE_PROJECT_REPONAME:-multi-cloud-app}
            echo "IMAGE_NAME=$IMAGE_NAME" > image_env.txt
            docker build -t $IMAGE_NAME:$IMAGE_TAG app/
      - persist_to_workspace:
          root: .
          paths:
            - image_env.txt
            - .

  push-and-deploy-aws:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Configure AWS credentials
          command: |
            python - <<'PY'
            import os,sys
            for v in ['AWS_ACCESS_KEY_ID','AWS_SECRET_ACCESS_KEY','AWS_DEFAULT_REGION']:
            if v not in os.environ:
            print('Missing env', v)
            sys.exit(1)
            print('AWS credentials present')
            PY

      - run:
          name: Login to ECR and push image
          command: |
            chmod +x ./scripts/push_to_ecr.sh
            ./scripts/push_to_ecr.sh ${IMAGE_TAG}
      - run:
          name: Terraform apply for AWS (ECR + ECS Fargate)
          command: |
            cd terraform/aws
            terraform init -input=false
            terraform apply -auto-approve -var="image_tag=${IMAGE_TAG}"

  push-and-deploy-azure:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Login to Azure (service principal)
          command: |
            if [ -z "$AZURE_CLIENT_ID" ] || [ -z "$AZURE_CLIENT_SECRET" ] || [ -z "$AZURE_TENANT_ID" ] || [ -z "$AZURE_SUBSCRIPTION_ID" ]; then
              echo "Azure environment variables missing"; exit 1
            fi
            az login --service-principal -u "$AZURE_CLIENT_ID" -p "$AZURE_CLIENT_SECRET" --tenant "$AZURE_TENANT_ID"
            az account set --subscription "$AZURE_SUBSCRIPTION_ID"
      - run:
          name: Push to ACR
          command: |
            chmod +x ./scripts/push_to_acr.sh
            ./scripts/push_to_acr.sh ${IMAGE_TAG}
      - run:
          name: Terraform apply for Azure
          command: |
            cd terraform/azure
            terraform init -input=false
            terraform apply -auto-approve -var="image_tag=${IMAGE_TAG}"
      - run:
          name: Update Web App to use new image
          command: |
            cd terraform/azure
            WEBAPP=$(terraform output -raw webapp_name)
            ACR_NAME=$(terraform output -raw acr_name)
            IMAGE_NAME=$(terraform output -raw image_name)
            FULL_IMAGE=${ACR_NAME}.azurecr.io/${IMAGE_NAME}:${IMAGE_TAG}
            az webapp config container set --name $WEBAPP --resource-group $(terraform output -raw resource_group) --docker-custom-image-name $FULL_IMAGE

workflows:
  build-deploy:
    jobs:
      - build-and-test
      - push-and-deploy-aws:
          requires:
            - build-and-test
          filters:
            branches:
              only: main
      - push-and-deploy-azure:
          requires:
            - build-and-test
          filters:
            branches:
              only: main