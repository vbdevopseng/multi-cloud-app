version: 2.1

# Orbs provide pre-packaged CircleCI configuration
orbs:
  terraform: circleci/terraform@3.2

jobs:
  # Job to prepare and deploy the static files (runs after apply)
  deploy_static_files:
    docker:
      - image: cimg/python:3.10  # Use a Python image for the `aws s3 sync` and `az storage blob upload-batch` commands
    steps:
      - checkout
      - run:
          name: Install AWS CLI and Azure CLI
          command: |
            # Install AWS CLI
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip awscliv2.zip
            sudo ./aws/install --update
            # Install Azure CLI
            curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
      - run:
          name: Deploy to AWS S3
          command: |
            # Check for deployment target (using a custom environment variable)
            if [ "$DEPLOY_TARGET" == "aws" ]; then
              echo "--- Deploying static files to AWS S3 ---"
              # Terraform outputs are passed via environment variables (TERRAFORM_OUTPUT_*)
              # The output variable name is WEBSITE_ENDPOINT, so it becomes TERRAFORM_OUTPUT_WEBSITE_ENDPOINT
              # The actual bucket name is extracted from the endpoint URL
              BUCKET_NAME=$(echo $TERRAFORM_OUTPUT_WEBSITE_ENDPOINT | cut -d'.' -f1)

              # 'aws s3 sync' handles copying files and setting public-read ACL
              aws s3 sync app/ s3://$BUCKET_NAME/ --acl public-read --delete
              echo "✅ AWS Deployment Complete. Website URL: http://$TERRAFORM_OUTPUT_WEBSITE_ENDPOINT"
            fi
      - run:
          name: Deploy to Azure Blob Storage
          command: |
            if [ "$DEPLOY_TARGET" == "azure" ]; then
              echo "--- Deploying static files to Azure Blob Storage ---"
              # Login to Azure using Service Principal credentials
              az login --service-principal -u $ARM_CLIENT_ID -p $ARM_CLIENT_SECRET --tenant $ARM_TENANT_ID

              # Storage Account Name is passed from a CircleCI environment variable for simplicity
              # In a real scenario, you'd get this from Terraform output/state
              az storage blob upload-batch \
                --account-name $AZURE_STORAGE_ACCOUNT_NAME \
                --destination '$web' \
                --source app/ \
                --auth-mode login # '$web' is the container created by static website hosting
              echo "✅ Azure Deployment Complete. Website URL: $TERRAFORM_OUTPUT_PRIMARY_WEB_ENDPOINT"
            fi

workflows:
  build_test_and_deploy:
    jobs:
      # AWS Deployment Path
      - terraform/init:
          name: aws-tf-init
          context: terraform-creds
          path: terraform/aws
      - terraform/plan:
          name: aws-tf-plan
          context: terraform-creds
          path: terraform/aws
          requires:
            - aws-tf-init
      - hold:
          type: approval
          name: hold-for-aws-deploy
          requires:
            - aws-tf-plan
      - terraform/apply:
          name: aws-tf-apply
          context: terraform-creds
          path: terraform/aws
          requires:
            - hold-for-aws-deploy
      - deploy_static_files:
          name: aws-deploy-static
          context: terraform-creds
          DEPLOY_TARGET: "aws" # Custom env var to tell the deploy job which cloud to target
          requires:
            - aws-tf-apply

      # Azure Deployment Path
      - terraform/init:
          name: azure-tf-init
          context: terraform-creds
          path: terraform/azure
      - terraform/plan:
          name: azure-tf-plan
          context: terraform-creds
          path: terraform/azure
          requires:
            - azure-tf-init
      - hold:
          type: approval
          name: hold-for-azure-deploy
          requires:
            - azure-tf-plan
      - terraform/apply:
          name: azure-tf-apply
          context: terraform-creds
          path: terraform/azure
          requires:
            - hold-for-azure-deploy
      - deploy_static_files:
          name: azure-deploy-static
          context: terraform-creds
          DEPLOY_TARGET: "azure"
          AZURE_STORAGE_ACCOUNT_NAME: ${AZURE_STORAGE_ACCOUNT_NAME} # Passing the variable
          requires:
            - azure-tf-apply
